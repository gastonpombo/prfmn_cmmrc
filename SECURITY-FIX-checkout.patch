# üîí FIX CR√çTICO: Validaci√≥n de Precios y Stock en Checkout

## Aplicar este parche al archivo: app/api/checkout/route.ts

### Reemplazar la secci√≥n de c√°lculo de total (l√≠neas ~65-68) con:

```typescript
// ============================================
// 4. Validar productos y calcular total desde la DB
// ============================================

// üîí SEGURIDAD: NO confiar en precios del frontend
// Consultar precios reales desde la base de datos

const productIds = items.map(item => item.id)

const { data: realProducts, error: productsError } = await supabase
  .from('products')
  .select('id, name, price, stock')
  .in('id', productIds)

if (productsError || !realProducts) {
  console.error('‚ùå Error al obtener productos:', productsError)
  return NextResponse.json(
    { error: 'Error al validar productos' },
    { status: 500 }
  )
}

// Validar que todos los productos existan
if (realProducts.length !== items.length) {
  const missingIds = items
    .filter(item => !realProducts.find(p => p.id === item.id))
    .map(item => item.id)

  console.error('‚ùå Productos no encontrados:', missingIds)
  return NextResponse.json(
    { error: 'Algunos productos no est√°n disponibles' },
    { status: 400 }
  )
}

// Validar stock y calcular total con precios reales
let total_amount = 0
const validationErrors: string[] = []

for (const item of items) {
  const dbProduct = realProducts.find(p => p.id === item.id)

  if (!dbProduct) {
    validationErrors.push(`Producto ${item.name} no encontrado`)
    continue
  }

  // Validar stock disponible
  if (dbProduct.stock < item.quantity) {
    validationErrors.push(
      `Stock insuficiente para ${dbProduct.name}. ` +
      `Disponible: ${dbProduct.stock}, solicitado: ${item.quantity}`
    )
    continue
  }

  // ‚úÖ Usar precio real de la base de datos
  total_amount += dbProduct.price * item.quantity

  // Log de diferencia si el frontend envi√≥ precio incorrecto
  if (Math.abs(item.price - dbProduct.price) > 0.01) {
    console.warn(
      `‚ö†Ô∏è Precio incorrecto detectado para producto ${dbProduct.name}: ` +
      `frontend=${item.price}, db=${dbProduct.price}`
    )
  }
}

// Si hay errores de validaci√≥n, retornar error
if (validationErrors.length > 0) {
  return NextResponse.json(
    {
      error: 'Error de validaci√≥n',
      details: validationErrors
    },
    { status: 400 }
  )
}

// Validar total final
if (total_amount <= 0) {
  return NextResponse.json(
    { error: 'El total debe ser mayor a 0' },
    { status: 400 }
  )
}

console.log(`‚úÖ Validaci√≥n completada: Total calculado = $${total_amount}`)
```

### Tambi√©n actualizar la creaci√≥n de order_items para usar precios reales:

```typescript
// ============================================
// PASO 2: Insertar los order_items (CON PRECIOS VALIDADOS)
// ============================================

const orderItems = items.map((item) => {
  const dbProduct = realProducts.find(p => p.id === item.id)!

  return {
    order_id: orderId,
    product_id: item.id,
    quantity: item.quantity,
    unit_price: dbProduct.price, // ‚úÖ Usar precio real de la DB
  }
})

const { error: itemsError } = await supabase.from("order_items").insert(orderItems)
```

---

## Beneficios de este Fix:

‚úÖ **Previene fraude:** Usuario no puede manipular precios
‚úÖ **Valida stock:** Evita √≥rdenes inv√°lidas
‚úÖ **Detecta discrepancias:** Log si frontend env√≠a precio incorrecto
‚úÖ **Mejor UX:** Usuario sabe inmediatamente si no hay stock
‚úÖ **Seguridad financiera:** Total calculado server-side

---

## Testing despu√©s del fix:

```bash
# Test 1: Compra normal (deber√≠a funcionar)
curl -X POST http://localhost:3000/api/checkout \
  -H "Content-Type: application/json" \
  -d '{
    "items": [{"id": 1, "name": "Perfume A", "price": 15000, "quantity": 1}],
    "customer_info": {"name": "Test", "email": "test@test.com"}
  }'

# Test 2: Precio manipulado (deber√≠a usar precio de DB y logear warning)
curl -X POST http://localhost:3000/api/checkout \
  -H "Content-Type: application/json" \
  -d '{
    "items": [{"id": 1, "name": "Perfume A", "price": 0.01, "quantity": 1}],
    "customer_info": {"name": "Test", "email": "test@test.com"}
  }'
# Esperado: Orden creada con precio real ($15000), no con $0.01

# Test 3: Stock insuficiente (deber√≠a fallar)
curl -X POST http://localhost:3000/api/checkout \
  -H "Content-Type: application/json" \
  -d '{
    "items": [{"id": 1, "name": "Perfume A", "price": 15000, "quantity": 9999}],
    "customer_info": {"name": "Test", "email": "test@test.com"}
  }'
# Esperado: Error 400 "Stock insuficiente"
```
